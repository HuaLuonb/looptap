<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="Cache-control" content="public" />
		<meta
			name="viewport"
			content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
		/>
		<meta name="description" content="A minimal game to waste your time." />
		<meta name="keywords" content="minimal game, html5 game, svg game" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="apple-mobile-web-app-title" content="Looptap" />
		<meta name="application-name" content="Looptap" />
		<meta name="theme-color" content="#FFFFFF" />
		<meta property="og:url" content="https://looptap.vasanthv.com" />
		<meta property="og:image" content="https://looptap.vasanthv.com/apple-touch-icon.png" />
		<meta property="og:title" content="Looptap" />
		<meta property="og:description" content="A minimal game to waste your time." />
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-19124340-30"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'UA-19124340-30');
		</script>
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
		<link rel="manifest" href="/manifest.json" />
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#2c3d51" />
		<meta name="msapplication-TileColor" content="#ffffff" />
		<meta name="theme-color" content="#ffffff" />
		<title>Looptap - A minimal game to waste your time</title>
		<style>
			html,
			body {
				overscroll-behavior: none;
			}
			body {
				font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu,
					'Helvetica Neue', sans-serif;
				margin: 0;
				line-height: 1.5;
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
				-webkit-text-size-adjust: 100%;
				background: #fbf9f6;
			}
			a {
				color: inherit;
			}
			#canvas {
				display: flex;
				height: 100vh;
				width: 100%;
				max-width: 640px;
				overflow: hidden;
				box-sizing: border-box;
				margin: auto;
				flex-direction: column;
				justify-content: center;
			}
			#canvas svg {
				width: 100%;
			}
			#about {
				text-align: center;
				font-size: 1.2rem;
				line-height: 1.75;
				padding: 0rem 2rem 1rem;
				color: #2c3d51;
			}
			#about a {
				font-weight: 500;
				font-style: italic;
			}
			#ball {
				transform: translateZ(0);
				animation: rot 2000ms infinite linear;
				animation-play-state: paused;
			}
			#play {
				cursor: pointer;
			}
			.score {
				display: none;
			}
			#finalscore,
			#best {
				font-size: 70%;
				display: none;
				fill: #34495e;
			}
			#best {
				font-style: italic;
				font-size: 50%;
			}
			#tip {
				font-weight: 300;
				font-size: 25%;
				font-style: italic;
				padding: 0.5rem 2rem 0rem;
			}

			@keyframes rot {
				from {
					transform: rotate(0deg) translate(40%) rotate(0deg);
				}
				to {
					transform: rotate(360deg) translate(40%) rotate(-360deg);
				}
			}
		</style>
	</head>

	<body>
		<section id="canvas">
			<svg id="looptap" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
				<rect id="bg" x="0" cy="0" height="100" width="100" fill="none" />
				<text
					x="50"
					y="50"
					dominant-baseline="middle"
					text-anchor="middle"
					class="score"
					id="score"
				></text>
				<text x="50" y="32" text-anchor="middle" class="score" id="finalscore"></text>
				<text x="50" y="70" text-anchor="middle" class="score" id="best"></text>
				<g id="tip">
					<text x="50" y="68" text-anchor="middle" class="tip">
						Tap anywhere when the ball
					</text>
					<text x="50" y="74" text-anchor="middle" class="tip">is on the colored area.</text>
				</g>
				<path
					id="arc"
					fill="none"
					stroke="#2ecc71"
					stroke-width="10"
					stroke-linejoin="round"
					stroke-linecap="round"
				/>
				<circle id="ball" cx="50" cy="50" r="4" fill="#2C3D51" />
				<polygon
					id="play"
					points="45,45 55,50 45,55"
					fill="#2C3D51"
					stroke="#2C3D51"
					stroke-width="5"
					stroke-linejoin="round"
					stroke-linecap="round"
				/>
			</svg>
			<div id="about">
				Looptap is made by
				<a href="https://vasanthv.com" target="_blank">Vasanth.V</a><br />
				and it is based on the iOS game
				<a href="https://coogyloop.com/" target="_blank">Coogyloop</a>.
				<br />
				<a
					href="https://twitter.com/share?ref_src=twsrc%5Etfw"
					class="twitter-share-button"
					data-text="Looptap - a minimal game to waste your time."
					data-url="https://looptap.vasanthv.com"
					data-via="vsnthv"
					data-hashtags="looptap"
					data-show-count="false"
					>Tweet</a
				>
				<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
			</div>
		</section>
		<script type="text/javascript">
			let arc = [];
			let score = 0;
			const colors = [
				'#ED5565',
				'#D9444F',
				'#ED5F56',
				'#DA4C43',
				'#F87D52',
				'#E7663F',
				'#FAB153',
				'#F59B43',
				'#FDCE55',
				'#F6BA43',
				'#C2D568',
				'#B1C353',
				'#99D469',
				'#83C251',
				'#42CB70',
				'#3CB85D',
				'#47CEC0',
				'#3BBEB0',
				'#4FC2E7',
				'#3CB2D9',
				'#5C9DED',
				'#4C8CDC',
				'#9398EC',
				'#7277D5',
				'#CC93EF',
				'#B377D9',
				'#ED87BF',
				'#D870AE'
			];
			let state = 'init';

			function is_touch_device() {
				return 'ontouchstart' in window;
			}

			const compose = (...fs) => x => fs.reduce((acc, f) => f(acc), x);

			function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
				const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;
				return {
					x: centerX + radius * Math.cos(angleInRadians),
					y: centerY + radius * Math.sin(angleInRadians)
				};
			}

			function describeArc(x, y, radius, startAngle, endAngle) {
				const start = polarToCartesian(x, y, radius, endAngle);
				const end = polarToCartesian(x, y, radius, startAngle);
				const arcFlag = endAngle - startAngle <= 180 ? '0' : '1';
				const d = ['M', start.x, start.y, 'A', radius, radius, 0, arcFlag, 0, end.x, end.y].join(
					' '
				);
				return d;
			}

			function angle(cx, cy, ex, ey) {
				const dy = ey - cy;
				const dx = ex - cx;
				let theta = Math.atan2(dx, -dy);
				theta *= 180 / Math.PI;
				theta = theta < 0 ? theta + 360 : theta;
				return theta;
			}

			function getBallAngle() {
				const bg = document.getElementById('bg').getBoundingClientRect();
				const bgCenter = { x: bg.left + bg.width / 2, y: bg.top + bg.height / 2 };
				const ball = document.getElementById('ball').getBoundingClientRect();
				const ballCenter = { x: ball.left + ball.width / 2, y: ball.top + ball.height / 2 };
				return angle(bgCenter.x, bgCenter.y, ballCenter.x, ballCenter.y);
			}

			function setArc() {
				const random = (i, j) => Math.floor(Math.random() * (j - i)) + i;
				arc = [];
				arc.push(random(0, 300));
				arc.push(random(arc[0] + 10, arc[0] + 110));
				arc[1] = arc[1] > 360 ? 360 : arc[1];
				document.getElementById('arc').setAttribute('d', describeArc(50, 50, 40, arc[0], arc[1]));
				document.getElementById('arc').style.stroke = colors[Math.floor(score / 10)];
			}

			function playBtn() {
				document.getElementById('play').style.display = state == 'started' ? 'none' : 'block';
			}

			function scoreField() {
				const scoreEle = document.getElementById('score');

				scoreEle.textContent = score;
				scoreEle.style.display = state == 'started' ? 'block' : 'none';
			}

			function animateBall() {
				const ballEle = document.getElementById('ball');
				if (state == 'started') {
					ballEle.style.animationDuration = 2000 - score * 15 + 'ms';
				} else {
					ballEle.style.animationPlayState = 'paused';
				}
			}

			function finalScore() {
				const finalScoreEle = document.getElementById('finalscore');
				finalScoreEle.textContent = score;
				finalScoreEle.style.display = state == 'stopped' ? 'block' : 'none';
			}

			function best() {
				const bestEle = document.getElementById('best');
				if (window.localStorage.best > 0) {
					bestEle.textContent = 'Best: ' + window.localStorage.best;
					bestEle.style.display = state == 'started' ? 'none' : 'block';
				}
			}
			function hideTip() {
				document.getElementById('tip').style.display = 'none';
				document.getElementById('about').style.display = 'none';
			}

			function startPlay() {
				state = 'started';
				score = 0;
				compose(hideTip, setArc, playBtn, animateBall, scoreField, finalScore, best)();
				document.getElementById('ball').style.animationPlayState = 'running';

				// Add the event listnerers for tap sensing
				if (is_touch_device()) {
					window.addEventListener('touchstart', tap);
				} else {
					window.addEventListener('mousedown', tap);
				}
			}
			function stopPlay() {
				state = 'stopped';
				if (score > window.localStorage.best) window.localStorage.best = score;
				compose(playBtn, animateBall, scoreField, finalScore, best)();
			}

			function tap(e) {
				e.preventDefault();
				e.stopPropagation();
				const ballAngle = getBallAngle();
				// adding a 5 for better accuracy as the arc stroke extends beyond the angle.
				if (ballAngle + 6 > arc[0] && ballAngle - 6 < arc[1]) {
					score++;
					compose(setArc, animateBall, scoreField)();
				} else stopPlay();
			}
			document.getElementById('play').addEventListener('click', startPlay);

			// Set an initial arc just for aesthetics
			setArc();

			// set best localstorage if there is not localstorage variable
			if (!window.localStorage.best) window.localStorage.best = 0;
		</script>
		<script type="text/javascript">
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('/sw.js');
			}
		</script>
	</body>
</html>
